<!doctype html>
<html lang="en" data-bs-theme="blue-theme">

<head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>AutoFill Tree - Aghan Promoters</title>
   <!--favicon-->
   <link rel="icon" href="assets/images/Logo/avatar.png" type="image/png">
   <!-- loader-->
   <link href="assets/css/pace.min.css" rel="stylesheet">
   <script src="assets/js/pace.min.js"></script>

   <!--plugins-->
   <link href="assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet">
   <link rel="stylesheet" type="text/css" href="assets/plugins/metismenu/metisMenu.min.css">
   <link rel="stylesheet" type="text/css" href="assets/plugins/metismenu/mm-vertical.css">
   <link rel="stylesheet" type="text/css" href="assets/plugins/simplebar/css/simplebar.css">
   <link rel="stylesheet" href="./assets/css/genealogy.css">
   <!--bootstrap css-->
   <link href="assets/css/bootstrap.min.css" rel="stylesheet">
   <link href="assets/plugins/datatable/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
   <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600&amp;display=swap"
      rel="stylesheet">
   <link href="https://fonts.googleapis.com/css?family=Material+Icons+Outlined" rel="stylesheet">
   <!--main css-->
   <link href="assets/css/bootstrap-extended.css" rel="stylesheet">
   <link href="sass/main.css" rel="stylesheet">
   <link href="sass/responsive.css" rel="stylesheet">

   <style>
      body {
         background-color: #182c25;
      }
   </style>
</head>

<body>


   <!--start header-->
   <header class="top-header">
      <nav class="navbar navbar-expand align-items-center gap-4">
         <div class="btn-toggle">
            <a href="javascript:;"><i class="material-icons-outlined">menu</i></a>
         </div>
         <div class="search-bar flex-grow-1">
            <div class="position-relative">

               <div class="search-popup p-3">
                  <div class="card rounded-4 overflow-hidden">
                     <div class="card-body search-content">
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <ul class="navbar-nav gap-1 nav-right-links align-items-center">
            <li class="nav-item dropdown">
               <a href="javascrpt:;" class="dropdown-toggle dropdown-toggle-nocaret" data-bs-toggle="dropdown">
                  <img src="assets/images/Logo/avatar.png" class="rounded-circle p-1 border" width="45" height="45"
                     alt="">
               </a>
               <div class="dropdown-menu dropdown-user dropdown-menu-end shadow">
                  <a class="dropdown-item  gap-2 py-2" href="javascript:;">
                     <div class="text-center">
                        <img src="assets/images/logo/avatar.png" class="rounded-circle p-1 shadow mb-3" width="90"
                           height="90" alt="">
                        <h5 class="user-name mb-0 fw-bold">Hello, Admin</h5>
                     </div>
                  </a>
                  <hr class="dropdown-divider">
                  <a class="dropdown-item d-flex align-items-center gap-2 py-2" href="edit company.html"><i
                        class="material-icons-outlined">person_outline</i>Company Information</a>
                  <a class="dropdown-item d-flex align-items-center gap-2 py-2" href="change password.html"><i
                        class="material-icons-outlined">lock</i>Change Password</a>
                  <hr class="dropdown-divider">
                  <a class="dropdown-item d-flex align-items-center gap-2 py-2" href="login.html"><i
                        class="material-icons-outlined">power_settings_new</i>Logout</a>
               </div>
            </li>
         </ul>

      </nav>
   </header>
   <!--end top header-->


   <!--start sidebar-->
   <aside class="sidebar-wrapper" data-simplebar="true">
      <div class="sidebar-header">
         <div class="logo-icon">
            <img src="assets/images/logo/avatar.png" style="width: 55px;" class="logo-img" alt="">
         </div>
         <div class="logo-name flex-grow-1">
            <h4 class="mb-0 text-light">AGHAN</h5>
         </div>
         <div class="sidebar-close">
            <span class="material-icons-outlined">close</span>
         </div>
      </div>
      <div class="sidebar-nav">
         <!--navigation-->
         <ul class="metismenu" id="sidenav">
            <li>
               <a href="index.html">
                  <div class="parent-icon"><i class="material-icons-outlined">home</i>
                  </div>
                  <div class="menu-title">Dashboard</div>
               </a>
            </li>


            <li>
               <a href="javascript:;" class="has-arrow">
                  <div class="parent-icon">
                     <i class="material-icons-outlined">apartment</i>

                  </div>
                  <div class="menu-title">Company</div>
               </a>
               <ul>
                  <li><a href="edit company.html"><i class="material-icons-outlined"></i>Edit Company</a>
                  </li>
                  <li><a href="change password.html"><i class="material-icons-outlined"></i>Change
                        Password</a></li>
                  <li>
                     <a href="javascript:;" class="has-arrow">
                        <i class="material-icons-outlined"></i>News
                     </a>
                     <ul>
                        <li><a href="add news.html"><i class="material-icons-outlined"></i>Add News</a></li>
                        <li><a href="edit news.html"><i class="material-icons-outlined"></i>Edit News</a>
                        </li>
                     </ul>
                  </li>
                  <li>
                     <a href="javascript:;" class="has-arrow">
                        <i class="material-icons-outlined"></i>Bank
                     </a>
                     <ul>
                        <li><a href="add bank.html"><i class="material-icons-outlined"></i>Add Bank</a></li>
                        <li><a href="edit bank.html"><i class="material-icons-outlined"></i>Edit Bank</a>
                        </li>
                     </ul>
                  </li>
                  <li>
                     <a href="javascript:;" class="has-arrow">
                        <i class="material-icons-outlined"></i>UPI
                     </a>
                     <ul>
                        <li><a href="add upi.html"><i class="material-icons-outlined"></i>Add UPI</a></li>
                        <li><a href="edit upi.html"><i class="material-icons-outlined"></i>Edit UPI</a></li>
                     </ul>
                  </li>
                  <li>
                     <a href="javascript:;" class="has-arrow">
                        <i class="material-icons-outlined"></i>User Alerts
                     </a>
                     <ul>
                        <li><a href="alert message.html"><i class="material-icons-outlined"></i>Alert
                              Message</a></li>
                        <li><a href="alert history.html"><i class="material-icons-outlined"></i>Alert
                              History</a></li>
                     </ul>
                  </li>
               </ul>
            </li>

            <li>
               <a class="has-arrow" href="javascript:;">
                  <div class="parent-icon"><i class="material-icons-outlined">event_note</i>
                  </div>
                  <div class="menu-title">Plans</div>
               </a>
               <ul>
                  <li>
                     <a href="javascript:;" class="has-arrow">
                        <i class="material-icons-outlined"></i>Packages
                     </a>
                     <ul>
                        <li><a href="add package.html"><i class="material-icons-outlined"></i>Add Package</a>
                        </li>
                        <li><a href="package history.html"><i class="material-icons-outlined"></i>Package
                              History</a></li>
                     </ul>
                  </li>

                  <li>
                     <a href="javascript:;" class="has-arrow">
                        <i class="material-icons-outlined"></i>Level Plan
                     </a>
                     <ul>
                        <li><a href="level income update.html"><i class="material-icons-outlined"></i>Update</a></li>
                        <li><a href="level income history.html"><i class="material-icons-outlined"></i>History</a></li>
                     </ul>
                  </li>

                  <li>
                     <a href="javascript:;" class="has-arrow">
                        <i class="material-icons-outlined"></i>Withdraw Deduction
                     </a>
                     <ul>
                        <li><a href="withdraw deduction.html"><i class="material-icons-outlined"></i>Update</a></li>
                        <li><a href="withdraw deduction history.html"><i class="material-icons-outlined"></i>History</a>
                        </li>
                     </ul>
                  </li>
               </ul>
            </li>

            <li>
               <a class="has-arrow" href="javascript:;">
                  <div class="parent-icon"><i class="material-icons-outlined">groups</i>
                  </div>
                  <div class="menu-title">Members</div>
               </a>
               <ul>
                  <li><a href="member list.html"><i class="material-icons-outlined"></i>Member List</a>
                  </li>
                  <li><a href="member filter.html"><i class="material-icons-outlined"></i>Members With
                        Filter</a>
                  </li>
               </ul>
            </li>

            <li class="mm-active">
               <a class="has-arrow" href="javascript:;">
                  <div class="parent-icon"><i class="material-icons-outlined">device_hub</i>
                  </div>
                  <div class="menu-title">Genealogy</div>
               </a>
               <ul class="mm-collbse mm-show">
                  <li class="mm-active"><a href="tree view.html"><i class="material-icons-outlined"></i>Tree
                        View</a>
                  </li>
                  <li><a href="my team.html"><i class="material-icons-outlined"></i>My Team View</a>
                  </li>
                  <li><a href="silver autofill.html"><i class="material-icons-outlined"></i>Silver
                        Autofill</a>
                  </li>
                  <li><a href="gold autofill.html"><i class="material-icons-outlined"></i>Gold Autofill</a>
                  </li>
                  <li><a href="diamond autofill.html"><i class="material-icons-outlined"></i>Diamond
                        Autofill</a>
                  </li>
                  <li><a href="platinum autofill.html"><i class="material-icons-outlined"></i>Platinum
                        Autofill</a>
                  </li>
                  <li><a href="king autofill.html"><i class="material-icons-outlined"></i>King Autofill</a>
                  </li>
               </ul>
            </li>

            <li>
               <a class="has-arrow" href="javascript:;">
                  <div class="parent-icon"><i class="material-icons-outlined">monetization_on</i>
                  </div>
                  <div class="menu-title">Transactions</div>
               </a>
               <ul>
                  <li>
                     <a href="javascript:;" class="has-arrow">
                        <i class="material-icons-outlined"></i>Add Fund
                     </a>
                     <ul>
                        <li><a href="add fund.html"><i class="material-icons-outlined"></i>Add Fund</a></li>
                        <li><a href="add fund history.html"><i class="material-icons-outlined"></i>Add Fund
                              History</a></li>
                     </ul>
                  </li>
                  <li><a href="fund request pending.html"><i class="material-icons-outlined"></i>Fund Request
                        Pending</a>
                  </li>
                  <li><a href="fund request approved.html"><i class="material-icons-outlined"></i>Fund
                        Request Approved</a>
                  </li>
                  <li><a href="fund request rejected.html"><i class="material-icons-outlined"></i>Fund
                        Request Rejected</a>
                  </li>
                  <li><a href="fund transfer history.html"><i class="material-icons-outlined"></i>Fund
                        Transfer</a>
                  </li>
               </ul>
            </li>

            <li>
               <a class="has-arrow" href="javascript:;">
                  <div class="parent-icon"><i class="material-icons-outlined">wallet</i>
                  </div>
                  <div class="menu-title">Income</div>
               </a>
               <ul>
                  <li><a href="sponsor income.html"><i class="material-icons-outlined"></i>Sponser Income</a>
                  </li>
                  <li><a href="level income.html"><i class="material-icons-outlined"></i>Level Income</a>
                  </li>
                  <li><a href="silver board income.html"><i class="material-icons-outlined"></i>Silver Board
                        Income</a>
                  </li>
                  <li><a href="gold board income.html"><i class="material-icons-outlined"></i>Gold Board
                        Income</a>
                  </li>
                  <li><a href="diamond board income.html"><i class="material-icons-outlined"></i>Diamond
                        Board Income</a>
                  </li>
                  <li><a href="platinum board income.html"><i class="material-icons-outlined"></i>Platinum
                        Board Income</a>
                  </li>
                  <li><a href="king board income.html"><i class="material-icons-outlined"></i>King Board
                        Income</a>
                  </li>
                  <li><a href="payout.html"><i class="material-icons-outlined"></i>Payout</a>
                  </li>
                  <li><a href="unpaid income.html"><i class="material-icons-outlined"></i>Unpaid Income</a>
                  </li>
                  <li><a href="paid income.html"><i class="material-icons-outlined"></i>Paid Income</a>
                  </li>
                  <li><a href="reject income.html"><i class="material-icons-outlined"></i>Reject Income</a>
                  </li>
               </ul>
            </li>


            <li>
               <a class="has-arrow" href="javascript:;">
                  <div class="parent-icon"><i class="material-icons-outlined">card_giftcard</i>
                  </div>
                  <div class="menu-title">Achievers</div>
               </a>
               <ul>
                  <li><a href="undelivered achievers.html"><i class="material-icons-outlined"></i>Undelivered
                        Achievers</a>
                  </li>
                  <li><a href="delivered achievers.html"><i class="material-icons-outlined"></i>Delivered
                        Achievers</a>
                  </li>
               </ul>
            </li>

            <li>
               <a href="user log.html">
                  <div class="parent-icon"><i class="material-icons-outlined">account_circle</i>
                  </div>
                  <div class="menu-title">User Log</div>
               </a>
            </li>

            <li>
               <a class="has-arrow" href="javascript:;">
                  <div class="parent-icon"><i class="material-icons-outlined">support_agent</i>
                  </div>
                  <div class="menu-title">Support</div>
               </a>
               <ul>
                  <li><a href="pending tickets.html"><i class="material-icons-outlined"></i>Pending
                        Tickets</a>
                  </li>
                  <li><a href="closed tickets.html"><i class="material-icons-outlined"></i>Closed Tickets</a>
                  </li>
               </ul>
            </li>

            <li>
               <a href="login.html">
                  <div class="parent-icon"><i class="material-icons-outlined">logout</i>
                  </div>
                  <div class="menu-title">Sign Out</div>
               </a>
            </li>
         </ul>
         <!--end navigation-->
      </div>
   </aside>
   <!--end sidebar-->


   <!--start main wrapper-->
   <main class="main-wrapper">
      <div class="main-content">
         <h4 class="text-light">Autofill Tree</h4>
         <!--end breadcrumb-->

         <style>
            .card {
               background-color: #005627 !important;
            }

            .table>:not(caption)>*>* {
               background-color: #005627 !important;
               color: #fff;
            }

            @media only screen and (max-width: 420px) {
               .tree.fourmatrix ul.first_level_mem>li>a {
                  width: 200px !important;
               }
            }

            .tree ul.second_level_mem>li>a {
               width: 70px !important;
            }

            .tree li a:hover .mem_info {
               display: block;
            }
         </style>

         <hr>
         <div class="card-inner">
            <div class="tree fourmatrix" style="height: 1000px;">
               <ul id="treeContainer"> </ul>
            </div>
            <div id="error-container"></div>
         </div>
      </div>



      </div>
      <br>
      </div>


      </div>
   </main>
   <!--end main wrapper-->

   <!--start overlay-->
   <div class="overlay btn-toggle"></div>
   <!--end overlay-->

   <!--bootstrap js-->
   <script src="assets/js/bootstrap.bundle.min.js"></script>

   <!--plugins-->
   <script src="assets/js/jquery.min.js"></script>
   <!--plugins-->
   <script src="assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
   <script src="assets/plugins/metismenu/metisMenu.min.js"></script>
   <script src="assets/plugins/datatable/js/jquery.dataTables.min.js"></script>
   <script src="assets/plugins/datatable/js/dataTables.bootstrap5.min.js"></script>
   <script src="assets/plugins/simplebar/js/simplebar.min.js"></script>
   <script src="assets/js/main.js"></script>

   <script>
      const token = sessionStorage.getItem('token');
      if (!token) {
         window.location.href = 'login.html';
      }

      function getUserIdFromQuery() {
         const urlParams = new URLSearchParams(window.location.search);
         const userId = urlParams.get('userId');
         return userId || null;
      }

      document.addEventListener('DOMContentLoaded', () => {
         fetchUserDetails()
            .then(userDetails => {
               const userId = userDetails.userId;
               fetchGenealogyData(userId);
            })
            .catch(error => {
               console.error('Error fetching user details:', error);
               displayErrorMessage(error.message);
            });
      });

      function getAuthToken() {
         return sessionStorage.getItem('token');
      }

      async function fetchGenealogyData(userId) {
         try {
            const userID = getUserIdFromQuery() || userId;
            const response = await fetch(`https://aghan-backend.onrender.com/tree/${userID}`, {
               headers: {
                  'Authorization': 'Bearer ' + getAuthToken()
               }
            });

            if (!response.ok) {
               const errorData = await response.json();
               const errorMessage = errorData.message || `HTTP error! Status: ${response.status}`;
               throw new Error(errorMessage);
            }

            const data = await response.json();
            renderGenealogyTree(data.genealogyTree);
         } catch (error) {
            console.error('Error fetching genealogy data:', error);
            displayErrorMessage(error.message);
         }
      }

      function createPlaceholderNode(level) {
         return {
            user_id: 'Inactive',
            username: 'Inactive',
            referrer_id: null,
            status: 'Inactive',
            level: level,
            children: []
         };
      }

      function renderGenealogyTree(treeData) {
         const treeContainer = document.getElementById('treeContainer');
         treeContainer.innerHTML = ''; // Clear previous content
         treeContainer.appendChild(createTreeElement(treeData));
      }

      function createTreeElement(node) {
         const li = document.createElement('li');
         const a = document.createElement('a');
         const img = document.createElement('img');
         const userInfo = document.createElement('div');

         img.src = 'assets/images/Logo/avatar.png';
         img.className = 'img-80 img-radius';

         userInfo.className = 'tree3_uinfo';
         userInfo.innerHTML = `${node.user_id || ''} <br> ${node.referrer_id || ''}`; // Removed N/A

         a.appendChild(img);
         a.appendChild(userInfo);

         a.classList.add(node.status === 'Active' ? 'active-member' : 'inactive-member');

         li.appendChild(a);


         if (node.status === 'Active') {  //Only add memInfo for active members
            const memInfo = document.createElement('div');
            memInfo.className = 'mem_info';
            memInfo.innerHTML = `<table>
                <tr><th>Name:</th><td>${node.username || 'Loading...'}</td></tr>
                <tr><th>ID:</th><td>${node.user_id || 'Loading...'}</td></tr>
                <tr><th>Parent:</th><td>${node.referrer_id || ''}</td></tr>
                <tr><th>Status:</th><td>${node.status || ''}</td></tr>
                <tr><th>Joined:</th><td>${node.joined ? new Date(node.joined).toLocaleDateString() : ''}</td></tr>
              </table>`;
            a.appendChild(memInfo);
         }

         if (node.level !== undefined && node.level < 2) {
            const ul = document.createElement('ul');
            ul.classList.add(node.level === 0 ? 'first_level_mem' : 'second_level_mem');

            const existingChildren = node.children || [];
            const totalSlots = 6;

            existingChildren.forEach(child => {
               ul.appendChild(createTreeElement(child));
            });

            for (let i = existingChildren.length; i < totalSlots; i++) {
               const placeholderNode = createPlaceholderNode(node.level + 1);
               ul.appendChild(createTreeElement(placeholderNode));
            }
            li.appendChild(ul);
         }

         return li;
      }

      async function fetchUserDetails() {
         try {
            const token = sessionStorage.getItem('token');
            if (!token) {
               throw new Error('Not logged in.');
            }

            const response = await fetch('https://aghan-backend.onrender.com/user', {
               headers: {
                  'Authorization': 'Bearer ' + token
               }
            });

            if (!response.ok) {
               const errorData = await response.json();
               const errorMessage = errorData.message || 'Failed to fetch user details.';
               throw new Error(errorMessage);
            }

            const data = await response.json();
            return {
               userId: data.user.user_id,
               role: data.user.role
            };
         } catch (error) {
            console.error('Error fetching user details:', error);
            throw error;
         }
      }

      function displayErrorMessage(message) {
         const errorContainer = document.getElementById('error-container');
         if (errorContainer) {
            errorContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
         }
      }
   </script>

</body>

<style>
   /* Styles for active and inactive members */
   .tree li a.active-member {
      border: 2px solid #28a745;
      /* Green border for active members */
      background-color: rgba(40, 167, 69, 0.1);
      /* Light green background */
   }

   .tree li a.inactive-member {
      border: 2px solid #6c757d;
      /* Gray border for inactive/vacant members */
      background-color: rgba(108, 117, 125, 0.1);
      /* Light gray background */
      opacity: 0.6;
   }

   .tree li a.inactive-member .tree3_uinfo {
      color: #6c757d;
   }

   .tree li a .mem_info {
      display: none;
      position: absolute;
      z-index: 10;
      background-color: #005627;
      color: white;
      border: 1px solid #28a745;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 250px;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
   }

   .tree li a:hover .mem_info {
      display: block;
   }

   .tree li a .mem_info table {
      width: 100%;
   }

   .tree li a .mem_info table th {
      text-align: left;
      padding-right: 10px;
      width: 40%;
   }

   .tree li a .mem_info table td {
      text-align: left;
   }
</style>

</html>